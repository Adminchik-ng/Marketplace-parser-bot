# Telegram Бот для Мониторинга Цен на Маркетплейсах

***

## Описание проекта

Это **Телеграм-бот**, предназначенный для автоматического мониторинга цен на товары с популярных маркетплейсов: **Wildberries, Ozon, Яндекс.Маркет и Joom**. Бот позволяет пользователям отслеживать актуальную цену, получать уведомления о снижении цены и управлять списком товаров. Кроме того, бот собирает статистику по активности пользователей и предоставляет административные инструменты.

***

## Основные возможности

- Парсинг сайтов маркетплейсов (Wildberries, Ozon, Яндекс.Маркет, Joom) по расписанию (каждые 120 минут) для получения актуальной цены на товар.
- Добавление, удаление и просмотр списка товаров для отслеживания.
- Получение отчетов по состоянию цены и уведомления о достижении целевой цены.
- Управление пользователями: добавление в базу, сбор статистики активности, возможность блокировки/разблокировки пользователей для админов.
- Разграничение ролей пользователей: обычный пользователь (**user**) и администратор (**admin**).

***

## Используемый технологический стек

- **aiogram** — фреймворк для разработки Telegram-ботов на Python.
- **Docker** — контейнеризация приложения.
- **PostgreSQL** — основная база данных для хранения пользователей, товаров и активности.
- **Redis** — хранение промежуточных данных в процессе взаимодействия (например, состояния FSM при добавлении товаров).

***

## Типы пользователей

| Роль    | Описание                            |
|---------|-----------------------------------|
| user    | Обычный пользователь бота          |
| admin   | Администратор с расширенными правами |

***

## Команды и сценарии взаимодействия

- `/start` — запуск бота, приветствие, добавление пользователя в базу и регистрация активности.  
- `/help` — справка по доступным командам.  
- `/info` — советы и рекомендации по использованию бота.  
- `/add` — поэтапное добавление товара для отслеживания (выбор маркетплейса из Wildberries, Ozon, Яндекс.Маркет, Joom, ввод ссылки и целевой цены).  
- `/list` — отображение списка отслеживаемых товаров пользователя.  
- `/remove` — удаление товара из списка с выбором через инлайн-кнопки.  
- `/summary` — отчет по текущей и минимальной цене с информацией о достижении цели.

**Для админов доступны дополнительные команды:**  
- `/ban <telegram_id>` — блокировка пользователя.  
- `/unban <telegram_id>` — разблокировка пользователя.  
- `/statistics` — получение статистики активности пользователей.

***

## Фоновый процесс мониторинга

- Каждые 2 часа происходит парсинг актуальных цен товаров в базе с помощью Playwright.
- Обновляются данные: текущая цена, минимальная цена за период, время последнего обновления, ошибки парсинга.
- При достижении или снижении цены до целевой — пользователю отправляется уведомление.

***

## Структура базы данных — ключевые возможности

- Таблица **users** хранит сведения о пользователях, их ролях, статусах активности и бана.
- Таблица **activity** фиксирует ежедневную активность пользователей — дату и количество действий в этот день.
- Таблица **products** содержит отслеживаемые товары, с привязкой к пользователям, URL товарами, текущей/целевой ценой, статусами мониторинга и результатами последнего парсинга.

***

## Инструкция по запуску бота

Для корректной работы бота необходимо выполнить следующие шаги:

1. **Установить браузер на компьютер**  
   Для парсинга страниц требуется браузер с поддержкой автоматизации. Подойдет любой Chromium-браузер, например Google Chrome.

2. **Установить зависимости Python**  
   Выполните команду:  
   ```bash
   pip install -r requirements.txt
   ```

3. **Установить движок Playwright и браузер Chromium**  
   Выполните команду:  
   ```bash
   playwright install chromium
   ```

4. **Настроить файл окружения**  
   - Скопируйте файл `.env.example` в `.env`  
   - Внесите свои данные и секреты, включая токен Telegram-бота.

5. **Запустить инфраструктуру в Docker**  
   Для работы базы данных PostgreSQL и кеша Redis необходимо иметь установленный Docker.  
   Запустите командой:  
   ```bash
   docker compose up
   ```
   Эта команда поднимет контейнеры с базой данных и Redis.

6. **Создать таблицы в базе данных**  
   Выполните миграцию и создайте необходимые таблицы:  
   ```bash
   python -m migration.create_tables
   ```

7. **Запустить бота**  
   Запустите основной скрипт бота командой:  
   ```bash
   python main.py
   ```